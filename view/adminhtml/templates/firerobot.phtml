<?php
/** @var \Demo\TinyMcePlugin\Block\Adminhtml\FireRobot $block */
?>
<link rel="stylesheet" type="text/css" href="https://cdn.scaleflex.it/plugins/filerobot-widget/1.0.73/filerobot-widget.min.css?func=proxy" />
<script type="text/javascript" src="https://cdn.scaleflex.it/plugins/filerobot-widget/1.0.73/filerobot-widget.min.js?func=proxy"></script>

<button style="display: none" id="file-robot-modal-btn"></button>
<div id="modal-content">
    <div id="filerobot-widget"></div>
</div>
<script type="text/javascript">
    require(["jquery", "Magento_Ui/js/modal/modal"],function(jQuery, modal) {
        var options = {
            type: 'popup',
            responsive: true,
            title: '',
            buttons: []
        };

        const Filerobot = window.Filerobot

        const demoContainer = 'fyjnhqim'
        const demoSecurityTemplateID = 'SECU_C19B5A2656F645FAA4FFA40D40C6F599'

        var popup = modal(options, jQuery('#modal-content'))
        const filerobot = Filerobot.Core({
            securityTemplateID: demoSecurityTemplateID,
            container: demoContainer
        });

        const Explorer = Filerobot.Explorer
        const XHRUpload = Filerobot.XHRUpload
        const ImageEditor = Filerobot.ImageEditor
        const Webcam = Filerobot.Webcam

        filerobot
            .use(Explorer, {
                config: {
                    limit: 50,
                    tagging: {
                        language: 'en',
                        confidence: 60,
                        limit: 10,
                        provider: 'google'
                    }
                },
                target: '#filerobot-widget',
                inline: true,
                width: '100%',
                height: 530,
                showDetailsView: true,
                locale: {
                    strings: {
                        export: 'Insert'
                    }
                },
            })
            .use(XHRUpload)
            .use(ImageEditor, {
                cloudimageToken: 'SECU_C19B5A2656F645FAA4FFA40D40C6F599' // not needed if the same container value provided in core
            })
            .use(Webcam)
            .on('export', function(files, popupExportSuccessMsgFn, downloadFilesPackagedFn, downloadFileFn) {
                files.forEach((selected, key) => {
                    window.fileRobotActiveEditor.execCommand('mceInsertContent', false, '<div>' +
                        '<img src="'+selected.file.url.cdn+'" alt="'+selected.file.url.name+'" /> ' +
                        '</div>');
                })
                window.fileRobotActiveEditor = undefined
                jQuery('#modal-content').modal('closeModal')
                files = []
                return false
            })


        jQuery("#file-robot-modal-btn").click(function() {
            jQuery('#modal-content').modal('openModal')
        })
    })
</script>
